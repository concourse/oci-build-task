#!/bin/bash

set -e -u

tag=""
version=""

case $GITHUB_REF in
  refs/heads/*)
    tag=${GITHUB_REF#refs/heads/}
    ;;

  refs/tags/v[0-9]*)
    version=${GITHUB_REF#refs/tags/v}
    ;;

  refs/tags/*)
    tag=${GITHUB_REF#refs/tags/}
    ;;

  refs/pull/[0-9]*/merge)
    tag=${GITHUB_REF#refs/pull/}
    tag=${tag%/merge}
    tag=pr$tag
    ;;

  *)
    tag=$GITHUB_SHA
    ;;
esac

if [[ -n "$tag" ]]; then
  exec /opt/resource/out . <<EOF
{
  "source": {
    "repository": "concourse/oci-build-task",
    "username": "$DOCKER_USERNAME",
    "password": "$DOCKER_PASSWORD",
    "tag": "$tag"
  },
  "params": {
    "image": "./image/image.tar"
  }
}
EOF
else
  exec /opt/resource/out . <<EOF
{
  "source": {
    "repository": "concourse/oci-build-task",
    "username": "$DOCKER_USERNAME",
    "password": "$DOCKER_PASSWORD"
  },
  "params": {
    "image": "./image/image.tar",
    "version": "$version",
    "bump_aliases": true
  }
}
EOF
fi
